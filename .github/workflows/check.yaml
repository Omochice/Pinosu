name: Code check

on:
  push: null
  pull_request:
    branches:
      - main

permissions: {}

jobs:
  path-filter:
    timeout-minutes: 5
    outputs:
      # keep-sorted start
      actions: ${{steps.changes.outputs.actions}}
      android: ${{steps.changes.outputs.android}}
      renovate: ${{steps.changes.outputs.renovate}}
      version: ${{steps.changes.outputs.version}}
      # keep-sorted end
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            actions:
              - .github/workflows/*.yaml
              - devbox.json
              - devbox.lock
            android:
              - build.gradle.kts
              - settings.gradle.kts
              - gradle/**/*
              - gradle.properties
              - gradlew
              - gradlew.bat
              - app/**/*
              - devbox.json
              - devbox.lock
            renovate:
              - renovate.json5
              - devbox.json
              - devbox.lock
            version:
              - version.json
  check-actions:
    needs: path-filter
    if: needs.path-filter.outputs.actions == 'true'
    timeout-minutes: 5
    name: Check github actions files
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: true
      - run: devbox run actionlint
      - run: devbox run ghalint run
      - run: devbox run zizmor .github/
  check-format:
    timeout-minutes: 5
    name: Check code format
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: true
      - run: devbox run fmt
      - run: git diff
  test-android:
    timeout-minutes: 15
    name: Test Android code
    needs: path-filter
    if: needs.path-filter.outputs.android == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: true
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Run unit tests with coverage
        run: devbox run ./gradlew detekt testDebugUnitTest koverXmlReportDebug
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: kover-coverage
          path: app/build/reports/kover/reportDebug.xml
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: reports
          path: app/build/reports/
  instrumentation-test:
    timeout-minutes: 15
    name: Test Android E2E
    needs: path-filter
    if: needs.path-filter.outputs.android == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: true
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Run instrumented tests with coverage
        uses: reactivecircus/android-emulator-runner@b530d96654c385303d652368551fb075bc2f0b6b # v2.35.0
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel
          disable-animations: true
          script: devbox run ./gradlew :app:connectedDebugAndroidTest :app:jacocoInstrumentationTestReport --stacktrace
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: jacoco-coverage
          path: app/build/reports/jacoco/jacocoInstrumentationTestReport/jacocoInstrumentationTestReport.xml
  build-apk:
    timeout-minutes: 10
    name: Build Android APK
    needs: path-filter
    if: needs.path-filter.outputs.android == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: true
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - run: devbox run ./gradlew assembleDebug
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: app-debug-${{ github.sha }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
  check-renovate:
    timeout-minutes: 5
    name: Check Renovate config
    needs: path-filter
    if: needs.path-filter.outputs.renovate == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: true
      - run: devbox run renovate-config-validator --strict
  check-version-code:
    timeout-minutes: 5
    name: Check versionCode increment
    needs: path-filter
    if: needs.path-filter.outputs.version == 'true' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Check versionCode is incremented
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          PR_VERSION_CODE=$(jq -r '.versionCode' version.json)
          BASE_VERSION_CODE=$(gh api "repos/${{ github.repository }}/contents/version.json?ref=${BASE_REF}" \
            --jq '.content' | base64 -d | jq -r '.versionCode')

          echo "PR versionCode: $PR_VERSION_CODE"
          echo "Base versionCode: $BASE_VERSION_CODE"

          if [[ "$PR_VERSION_CODE" -ge $((BASE_VERSION_CODE + 1)) ]]; then
            echo "versionCode is properly incremented"
            exit 0
          else
            echo "Error: versionCode must be incremented (expected >= $((BASE_VERSION_CODE + 1)), got $PR_VERSION_CODE)"
            exit 1
          fi
  coverage-report:
    timeout-minutes: 5
    name: Report Coverage
    needs:
      - path-filter
      - test-android
      - instrumentation-test
    if: |
      needs.path-filter.outputs.android == 'true' &&
      (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: write
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kover-coverage
          path: coverage/kover
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: jacoco-coverage
          path: coverage/jacoco
      - uses: k1LoW/octocov-action@73d561f65d59e66899ed5c87e4621a913b5d5c20 # v1.5.0
        with:
          config: octocov.yaml
  status-check:
    timeout-minutes: 5
    name: Status Check
    runs-on: ubuntu-latest
    needs:
      # keep-sorted start
      - build-apk
      - check-actions
      - check-format
      - check-renovate
      - check-version-code
      - coverage-report
      - instrumentation-test
      - test-android
      # keep-sorted end
    permissions: {}
    if: failure()
    steps:
      - run: exit 1
